<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>UnicodeMathML Playground</title>

    <script>

        // prevent caching
        function loadUncachedStylesheet(path) {
            document.write('<link rel="stylesheet" href="' + path + '?' + Math.random() + '">');
        }
        function loadUncachedScript(path) {
            document.write('<script src="' + path + '?' + Math.random() + '"></scr' + 'ipt>');
        }
    </script>

    <link rel="stylesheet" href="playground-assets/lib/iosevka/01-iosevka-2.0.1/webfont.css">
    <link rel="stylesheet" href="playground-assets/lib/latinmodern/latinmodern-math-1959/webfont.css">
    <script>loadUncachedStylesheet("playground-assets/playground.css")</script>
</head>
<body>
    <h1>UnicodeMathML <em>ğğ“ğ”ğš¢ğ—´ğ‘Ÿğ–”ğ“Šğ™£ğ••<!--ğğ“ğ”ğš¢Í›ğ—´ğ‘Ÿğ–”âƒ—ğ“Šğ™£Í–ğ••--></em></h1>
    <aside id="config"><h2>âš™ï¸</h2></aside>
    <table class="playground">
        <tr>
            <td>
                <textarea id="input" placeholder="Put some UnicodeMath here..."></textarea>
                <div id="codepoints"></div>
            </td>
            <td>
                <div id="output"></div>
                <div class="tabs">
                    <button class="tab" id="pegjs_ast">PEG.js AST <span id="measurements_parse"></span></button>
                    <button class="tab" id="preprocess_ast"><abbr title="Preprocessed">PP</abbr> AST <span id="measurements_preprocess"></span></button>
                    <button class="tab" id="mathml_ast">MathML AST <span id="measurements_transform"></span></button>
                    <button class="tab active" id="source">MathML source <span id="measurements_pretty"></span></button>
                </div>
                <div class="tabcontent">
                    <pre id="output_pegjs_ast"></pre>
                    <pre id="output_preprocess_ast"></pre>
                    <pre id="output_mathml_ast"></pre>
                    <pre id="output_source"></pre>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <p class="history">
                    <span class="category">History</span>
                    <span id="history">
                        <button class="unicode disabled">empty</button>
                    </span>
                </p>
                <script>

                    // print buttons and extract tooltip data for later use
                    var buttons = [
                        {label: 'ğŸ', explanation: 'Operators with a special meaning in UnicodeMath, hover over each button for more information.', symbols: {
                            'â–’': 'n-aryand concatenation operator',
                            'â–ˆ': 'Array operator',
                            'â–­': 'Enclosure operator',
                            'â–¡': 'Abstract box operator',
                            'â– ': 'Matrix operator',
                            'â–': 'Underline operator',
                            'Â¦': 'Atop operator',
                            'â’': 'Choose operator (useful for binomial coefficients)',
                            'â”œ': 'Open delimiter',
                            'â”¤': 'Close delimiter',
                            'â”¬': 'Below operator',
                            'â”´': 'Above operator',
                            'Â©': 'Choice operator',
                            'ã€–': 'Invisible opening bracket',
                            'ã€—': 'Invisible closing bracket',
                            'â’¨': 'Parenthesized matrix (pmatrix) operator',
                            'â„²': 'Size override operator',
                            'â„': 'Skewed fraction operator',
                            'âˆ•': 'Linear fraction operator',
                            'âŠ˜': 'Small fraction operator',
                            'â”‚': 'Vertical bar separator',
                            'âˆ£': '\\mid character',
                            'âœ': 'Math color operator (non-standard)',
                            'â˜': 'Math background color operator (non-standard)',
                            'â«·': 'Start of comment (non-standard)',
                            'â«¸': 'End of comment (non-standard)',
                            'ï¿—': 'Typewriter/code font (non-standard)'
                            }},
                        {label: 'Operators', explanation: 'These are just examples â€“ most non-alphabetic and non-numeric characters that have no special role in UnicodeMath are recognized as operators.', symbols: 'Ã—â‹…âˆˆâˆ‹âˆ¼â‰ƒâ‰…â‰ˆâ‰â‰¡â‰¤â‰¥â‰¶â‰·â‰½â‰ºâ‰»â‰¼âŠ‚âŠƒâŠ†âŠ‡âŠ‘âŠ’'},
                        {label: 'N-ary operators', explanation: 'These are just examples â€“ more exists (mostly integral variants).', symbols: 'âˆ‘âˆâˆ«âˆ¬âˆ­â¨Œâˆ®âˆ±â¨‘â‹‚â‹ƒâ¨ƒâ¨„â¨€â¨â¨‚'},
                        {label: 'Logic operators', symbols: 'âˆƒâˆ€Â¬âˆ§âˆ¨â‡’â‡”âŠ•âŠ¤âŠ¥âŠ¢'},
                        {label: 'DB operators', symbols: 'â¨¯â¨âŸ•âŸ–âŸ—â‹‰â‹Šâ–·Ã·Ï€Ïƒ'},
                        {label: 'Invisible operators', symbols: {
                            '2061': 'Invisible function application',
                            '2062': 'Invisible times',
                            '2063': 'Invisible separator',
                            '2064': 'Invisible plus'
                            }},
                        {label: 'Spaces', symbols: {
                            'â€‹': ['Zero-width space', 'width: 1em'],
                            'â€Š': ['1/18em space (veryverythinmathspace)', 'width: 1.1em'],
                            'â€Šâ€Š': ['2/18em space (verythinmathspace)', 'width: 1.2em'],
                            'â€‰': ['3/18em space (thinmathspace)', 'width: 1.3em'],
                            'âŸ': ['4/18em space (mediummathspace)', 'width: 1.4em'],
                            'â€…': ['5/18em space (thickmathspace)', 'width: 1.5em'],
                            'â€„': ['6/18em space (verythickmathspace)', 'width: 1.6em'],
                            'â€„â€Š': ['7/18em space (veryverythickmathspace)', 'width: 1.7em'],
                            'â€‚': ['9/18em space', 'width: 1.9em'],
                            'â€ƒ': ['1em space', 'width: 2.8em'],
                            'â€‡': ['Digit-width space', 'width: 1.67em'],
                            'Â ': ['Space-width space (non-breaking space)', 'width: 1.67em']
                            }},
                        {label: 'Roots', symbols: 'âˆšâˆ›âˆœ'},
                        {label: 'Superscripts', symbols: 'â°Â¹Â²Â³â´âµâ¶â·â¸â¹â±â¿âºâ»â¼â½â¾'},
                        {label: 'Subscripts', symbols: 'â‚€â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰â‚Šâ‚‹â‚Œâ‚â‚'},
                        {label: 'Delimiters', symbols: '()[]{}âŸ¨âŸ©âŒˆâŒ‰âŒŠâŒ‹'},
                        {label: 'Over/underbraces', symbols: 'âœâââŸâ â¡â´âµÂ¯'},
                        {label: 'Stretchy arrows', symbols: 'â†â†’â†”â‡â‡’â‡”â†©â†ªâ†¼â‡€â†½â‡âŠ¢âŠ£âŸµâŸ¶âŸ·âŸ¸âŸ¹âŸºâ†¦âŠ¨'},
                        {label: 'Enclosures', symbols: ['â–­', ' Ì„', 'â–', 'â–¢', 'â—‹', 'âŸŒ', 'âƒ§', 'â¬­']},
                        {label: 'Phantoms & Smashes', symbols: {
                            'âŸ¡': 'Phantom operator',
                            'â¬„': 'Horizontal phantom (hphantom) operator',
                            'â‡³': 'Vertical phantom (vphantom) operator',
                            'â¬': 'Smash operator',
                            'â¬†': 'Ascender smash (asmash) operator',
                            'â¬‡': 'Descender smash (dsmash) operator',
                            'â¬Œ': 'Horizontal smash (hsmash) operator'
                            }},
                        {label: 'Combining marks', explanation: 'These are just examples â€“ anything from the "Combining Diacritical Marks" and "Combining Diacritical Marks for Symbols" Unicode blocks works.', symbols: ['0302', '030C', '0303', '0301', '0300', '0307', '0308', '20DB', '0304', '20D7']},
                        {label: 'Differential, Exponential and Imaginary', symbols: 'â……â…†â…‡â…ˆâ…‰'},
                        {label: 'ğŸ‡¬ğŸ‡· Greek alphabet', symbols: 'Î‘Î±Î’Î²Î“Î³Î”Î´Î•ÎµÎ–Î¶Î—Î·Î˜Î¸Î™Î¹ÎšÎºÎ›Î»ÎœÎ¼ÎÎ½ÎÎ¾ÎŸÎ¿Î Ï€Î¡ÏÎ£ÏƒÎ¤Ï„Î¥Ï…Î¦Ï†Î§Ï‡Î¨ÏˆÎ©Ï‰'},
                    ];

                    // variable used later on
                    var symbolTooltips = {};

                    buttons.forEach(function(entry) {
                        var explanation = "";
                        if ('explanation' in entry) {
                            explanation = 'data-explanation="' + entry['explanation'].split('"').join("&quot;") + '"';
                        }
                        document.write(`<p><span class="category" ${explanation}>${entry['label']}</span> `);
                        var syms = {};
                        var specialCss = {};
                        if (typeof(entry['symbols']) == "string") {  // string
                            entry['symbols'].split('').forEach(c => syms[c] = "");
                        } else if (!(entry['symbols'] instanceof Array)) {  // dictionary (with tooltips)
                            Object.keys(entry['symbols']).forEach(function (c) {
                                if (/^[0-9A-F]+$/i.test(c)) {

                                    // hex code
                                    syms[String.fromCodePoint("0x" + c)] = entry['symbols'][c];
                                } else {

                                    // normal character
                                    syms[c] = entry['symbols'][c];
                                }
                            });
                        } else if (/^[0-9A-F]+$/i.test(entry['symbols'][0])) {  // list of codepoints
                            entry['symbols'].map(c => String.fromCodePoint("0x" + c)).forEach(c => syms[c] = "");
                        } else {  // just a list
                            entry['symbols'].forEach(c => syms[c] = "");;
                        }

                        Object.keys(syms).forEach(function (c) {

                            // extract styles, if available
                            var tooltip = syms[c];
                            var css = '';
                            if (syms[c] instanceof Array) {
                                var tooltip = syms[c][0];
                                var css = 'style="' + syms[c][1] + '"';
                                syms[c] = syms[c][0];
                            }

                            document.write(`<button class="unicode" ${css} data-tooltip="${tooltip}">${c}</button>`);
                        });
                        symbolTooltips = Object.assign({}, symbolTooltips, syms);
                    });
                </script>
                <p class="codepoint"><span class="category" data-explanation="Will insert the character corresponding to the hexadecimal escape into the UnicodeMath input field.">Codepoint</span>
                    <input type="text" id="codepoint" placeholder="1F52D"><button id="insert_codepoint" class="submit">â¥</button>
                </p>
                <p class="controlword"><span class="category" data-explanation="By default, the transformation pipeline is configured such that you can <em>also</em> enter control words into the UnicodeMath input field. They will be converted during the transformation stage.">Control word</span>
                    <input type="text" id="controlword" placeholder="\oint"><button id="insert_controlword" class="submit">â¥</button>
                </p>
                <p class="mathfonts">
                    <span class="category" data-explanation="If you want to convert multiple characters at a time, enter them into the UnicodeMath input field, select them and click one of these buttons. Any characters that cannot be converted will remain unchanged.">Math fonts</span>
                    <input type="text" id="mathchar" placeholder="A" maxlength="1"><button id="serif-bold" class="submit mathfont" data-tooltip="Serif & Bold">ğ€ğğ‚</button><button id="serif-italic" class="mathfont" data-tooltip="Serif & Italic">ğ´ğµğ¶</button><button id="serif-bolditalic" class="mathfont" data-tooltip="Serif & Bold & Italic">ğ‘¨ğ‘©ğ‘ª</button><button id="sans-normal" class="mathfont" data-tooltip="Sans-serif">ğ– ğ–¡ğ–¢</button><button id="sans-bold" class="mathfont" data-tooltip="Sans-serif & Bold">ğ—”ğ—•ğ—–</button><button id="sans-italic" class="mathfont" data-tooltip="Sans-serif & Italic">ğ˜ˆğ˜‰ğ˜Š</button><button id="sans-bolditalic" class="mathfont" data-tooltip="Sans-serif & Bold & Italic">ğ˜¼ğ˜½ğ˜¾</button><button id="script-normal" class="mathfont"  data-tooltip="Script">ğ’œâ„¬ğ’</button><button id="script-bold" class="mathfont" data-tooltip="Script & Bold">ğ“ğ“‘ğ“’</button><button id="fraktur-normal" class="mathfont" data-tooltip="Fraktur">ğ”„ğ”…â„­</button><button id="fraktur-bold" class="mathfont" data-tooltip="Fraktur & Bold">ğ•¬ğ•­ğ•®</button><button id="monospace-normal" class="mathfont" data-tooltip="Monospace">ğ™°ğ™±ğ™²</button><button id="doublestruck-normal" class="mathfont" data-tooltip="Double-struck">ğ”¸ğ”¹â„‚</button>
                </p>
                <p class="examples"><span class="category">Examples</span>
                    <script>
                        var examples = `
                            â…ˆÂ²=-1
                            E = mâ¢cÂ²
                            aÂ²â‹…bÂ²=cÂ²
                            fÌ‚(Î¾)=âˆ«_-âˆ^âˆâ–’f(x)â…‡^-2Ï€â…ˆxÎ¾ â…†x
                            (a + b)^n = âˆ‘_(k=0)^nâ–’(nÂ¦k) a^k b^(n-k)
                            _n C_k = nâ’k = n!/(k! â‹… (n-k)!)
                            âˆ_(k=0)^nâ–’nâ’k = HÂ²(n) / (n!)^(n+1) = (âˆ_(h=0)^nâ–’h^h) / (n!)^(n+1)
                            sinâ¡Î¸ = 1â„2 ğ‘’^(â…ˆâ¢Î¸) + "c.c."
                            W_Î´â‚Ïâ‚Ïƒâ‚‚^3Î²=U_Î´â‚Ïâ‚^3Î²+1/8Ï€^2â¢âˆ«_Î±â‚^Î±â‚‚â–’dÎ±'â‚‚[(U_Î´â‚Ïâ‚^2Î²-Î±'â‚‚U_Î´â‚Ïâ‚^1Î²)/U_Î´â‚Ïâ‚^0Î²]
                            1/2ğœ‹ âˆ«_0^2ğœ‹â–’â…†ğœƒ/(ğ‘+ğ‘ sinâ¡ğœƒ)=1/âˆš(ğ‘^2âˆ’ğ‘^2)

                            â(x_1+â‹¯+x_k)^(k " times")
                            (a + b)â”´â†’
                            (â– (a&b@c&d))
                            â–ˆ(10&x+&3&y=2@3&x+&13&y=4)
                            a /~ b
                            w^h^e^e^e^e
                            ğ›¼â‚‚Â³/(ğ›½â‚‚Â³ + ğ›¾â‚‚Â³)
                            âˆš(n&a + b)
                        `;
                        examples
                            .split("\n")
                            .map(e => e.trim())
                            .filter(e => e)
                            .forEach(e => document.write(`<button class="example">${e}</button>`));
                    </script>
                    â‹¯
                </p>
            </td>
        </tr>
    </table>

    <!-- config -->
    <script>
        var defaultConfig = {
            splitInput: true,
            resolveControlWords: true,
            displaystyle: true,
            debug: true,
            caching: true,
            tracing: false,
            forceMathJax: false,
            outputLaTeX: false,
        };
        var configDescriptions = {
            splitInput: "Split input into lines and process each line separately (as opposed to processing the entire input as a single expression)",
            resolveControlWords: "Resolve control words such as <code>\\alpha</code> or <code>\\u1f52d</code> to the respective character before parsing",
            displaystyle: "Present the results in <code>displaystyle</code> mode (as opposed to <code>textstyle</code> mode)",
            debug: "Enable <em>debug</em> mode, with additional <code>console.log</code> output but slightly slower",
            caching: "Generate the parser with <em>caching</em> enabled (â‰³20x faster than sans caching)",
            tracing: "Enable <em>tracing</em> and show parse trace (of lowermost expression) in a tab (âš  slow if caching disabled)",
            forceMathJax: "Force-enable MathJax in browsers that support MathML natively",
            outputLaTeX: "Enable <strong>EXPERIMENTAL</strong> LaTeX output (& force MathJax)",
        };

        var ummlConfig = JSON.parse(JSON.stringify(defaultConfig));  // clone it

        function renderConfigPane() {
            var e = document.getElementById("config");
            var i = 0;
            e.innerHTML += Object.keys(ummlConfig).map(k => {
                i++;
                return `<div><input type="checkbox" id="c${i}" name="${k}" ${ummlConfig[k]? "checked" : ""}><label for="c${i}">${configDescriptions[k]}</label></div>`;
            }).join("");
            e.innerHTML += `<div class="buttons"><button onclick="applyConfigAndReload()">Apply & Reload Page</button><a onclick="resetConfigAndReload()">Reset</a></div>`;
        }
        function loadConfigIntoPane() {
            var tempConfig = defaultConfig;
            if (window.localStorage.getItem("config")) {
                tempConfig = JSON.parse(localStorage.getItem('config'));
            }
            Array.from(document.querySelectorAll("#config input[type='checkbox']")).map(e => {
                e.checked = tempConfig[e.name];
                ummlConfig[e.name] = tempConfig[e.name];
            });
        }
        function applyConfigAndReload() {
            var tempConfig = {};
            Array.from(document.querySelectorAll("#config input[type='checkbox']")).map(e => {
                tempConfig[e.name] = e.checked;
            });
            localStorage.setItem('config', JSON.stringify(tempConfig));
            window.location.reload(false);
        }
        function resetConfigAndReload() {
            localStorage.setItem('config', JSON.stringify(defaultConfig));
            window.location.reload(false);
        }
        renderConfigPane();
        loadConfigIntoPane();
    </script>

    <!-- unicodemathml stuff -->
    <script src="lib/peg-0.10.0.min.js"></script>
    <script>
        var ummlParser = undefined;

        // load grammar from file, then generate parser
        var client = new XMLHttpRequest();
        client.open('GET', 'src/unicodemathml.pegjs' + "?" + Math.random());
        client.onreadystatechange = function() {
            if (client.readyState === 4) {
                try {
                    ummlParser = peg.generate(client.responseText, {cache: ummlConfig.caching, trace: ummlConfig.tracing});
                } catch (error) {
                    document.write("Error during parser generation: " + error + "<br>");
                    console.log(error);
                }
            }
        }
        client.send();
    </script>
    <script>loadUncachedScript("src/unicodemathml.js")</script>

    <!-- playground stuff -->
    <script src="playground-assets/lib/jquery.min.js"></script>
    <script src="playground-assets/charinfo.js">/* no need to avoid caching here â€“ it's massive and it's not gonna change */</script>
    <script>loadUncachedScript("playground-assets/playground.js")</script>
</body>
